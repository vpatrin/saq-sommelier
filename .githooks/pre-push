#!/usr/bin/env bash
# Pre-push hook ‚Äî run tests, check lock files.
# Install with: make install

set -e

echo "üîç Running pre-push checks..."

echo ""
echo "üì¶ Checking lock files..."
(cd backend && poetry check --lock)
(cd scraper && poetry check --lock)
(cd core && poetry check --lock)
(cd bot && poetry check --lock)

echo ""
echo "üóÑÔ∏è  Checking migration coverage..."
LAST_MIGRATION=$(git log main..HEAD -1 --format="%H" -- 'core/alembic/versions/')

if [ -n "$LAST_MIGRATION" ]; then
  RANGE="$LAST_MIGRATION..HEAD"
else
  RANGE="main..HEAD"
fi

if [ -n "$(git log "$RANGE" -1 --format=%H -- 'core/db/models*.py' 'core/db/base.py')" ]; then
  echo "‚ùå Model changes detected without a corresponding migration!"
  echo "   Run: make revision msg=\"description\""
  exit 1
fi

echo ""
make test

echo ""
echo "‚úÖ All checks passed ‚Äî pushing."
