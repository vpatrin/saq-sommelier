name: CI

on:
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "2.1.3"
  PYTHONDONTWRITEBYTECODE: 1
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

jobs:
  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: backend/.venv
          key: venv-backend-lint-${{ hashFiles('backend/poetry.lock') }}
      - run: cd backend && poetry install --only dev --no-interaction
      - run: make lint-backend

  lint-scraper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: scraper/.venv
          key: venv-scraper-lint-${{ hashFiles('scraper/poetry.lock') }}
      - run: cd scraper && poetry install --only dev --no-interaction
      - run: make lint-scraper

  lint-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: core/.venv
          key: venv-core-lint-${{ hashFiles('core/poetry.lock') }}
      - run: cd core && poetry install --only dev --no-interaction
      - run: make lint-core

  lint-bot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: bot/.venv
          key: venv-bot-lint-${{ hashFiles('bot/poetry.lock') }}
      - run: cd bot && poetry install --only dev --no-interaction
      - run: make lint-bot

  lint-dockerfiles:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: backend/Dockerfile
          ignore: DL3008,DL4006
      - uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: scraper/Dockerfile
          ignore: DL3008,DL4006

  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: backend/.venv
          key: venv-backend-${{ hashFiles('backend/poetry.lock') }}
      - run: cd backend && poetry install --no-interaction
      - run: make test-backend

  test-scraper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: scraper/.venv
          key: venv-scraper-${{ hashFiles('scraper/poetry.lock') }}
      - run: cd scraper && poetry install --no-interaction
      - run: make test-scraper

  test-bot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: bot/.venv
          key: venv-bot-${{ hashFiles('bot/poetry.lock') }}
      - run: cd bot && poetry install --no-interaction
      - run: make test-bot

  lint:
    needs: [lint-backend, lint-scraper, lint-core, lint-bot, lint-dockerfiles]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          if [ "${{ needs.lint-backend.result }}" != "success" ] || \
             [ "${{ needs.lint-scraper.result }}" != "success" ] || \
             [ "${{ needs.lint-core.result }}" != "success" ] || \
             [ "${{ needs.lint-bot.result }}" != "success" ] || \
             [ "${{ needs.lint-dockerfiles.result }}" != "success" ]; then
            exit 1
          fi

  test:
    needs: [test-backend, test-scraper, test-bot]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          if [ "${{ needs.test-backend.result }}" != "success" ] || \
             [ "${{ needs.test-scraper.result }}" != "success" ] || \
             [ "${{ needs.test-bot.result }}" != "success" ]; then
            exit 1
          fi
