name: CI

on:
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "2.1.3"
  PYTHONDONTWRITEBYTECODE: 1
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      scraper: ${{ steps.filter.outputs.scraper }}
      core: ${{ steps.filter.outputs.core }}
      bot: ${{ steps.filter.outputs.bot }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            scraper:
              - 'scraper/**'
            core:
              - 'core/**'
            bot:
              - 'bot/**'
            workflows:
              - '.github/workflows/**'

  lint-backend:
    needs: [changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: backend/.venv
          key: venv-backend-lint-${{ hashFiles('backend/poetry.lock') }}
      - run: cd backend && poetry install --only dev --no-interaction
      - run: make lint-backend

  lint-scraper:
    needs: [changes]
    if: needs.changes.outputs.scraper == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: scraper/.venv
          key: venv-scraper-lint-${{ hashFiles('scraper/poetry.lock') }}
      - run: cd scraper && poetry install --only dev --no-interaction
      - run: make lint-scraper

  lint-core:
    needs: [changes]
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: core/.venv
          key: venv-core-lint-${{ hashFiles('core/poetry.lock') }}
      - run: cd core && poetry install --only dev --no-interaction
      - run: make lint-core

  lint-bot:
    needs: [changes]
    if: needs.changes.outputs.bot == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: bot/.venv
          key: venv-bot-lint-${{ hashFiles('bot/poetry.lock') }}
      - run: cd bot && poetry install --only dev --no-interaction
      - run: make lint-bot

  lint-dockerfiles:
    needs: [changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.scraper == 'true' || needs.changes.outputs.bot == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: backend/Dockerfile
          ignore: DL3008,DL4006
      - uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: scraper/Dockerfile
          ignore: DL3008,DL4006
      - uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: bot/Dockerfile
          ignore: DL3008,DL4006

  test-backend:
    needs: [changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: backend/.venv
          key: venv-backend-${{ hashFiles('backend/poetry.lock') }}
      - run: cd backend && poetry install --no-interaction
      - run: make coverage-backend

  test-scraper:
    needs: [changes]
    if: needs.changes.outputs.scraper == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: scraper/.venv
          key: venv-scraper-${{ hashFiles('scraper/poetry.lock') }}
      - run: cd scraper && poetry install --no-interaction
      - run: make coverage-scraper

  test-bot:
    needs: [changes]
    if: needs.changes.outputs.bot == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: bot/.venv
          key: venv-bot-${{ hashFiles('bot/poetry.lock') }}
      - run: cd bot && poetry install --no-interaction
      - run: make coverage-bot

  audit-backend:
    needs: [changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: backend/.venv
          key: venv-backend-audit-${{ hashFiles('backend/poetry.lock') }}
      - run: cd backend && poetry install --only main --no-interaction
      - run: cd backend && .venv/bin/pip install pip-audit && .venv/bin/pip-audit

  audit-scraper:
    needs: [changes]
    if: needs.changes.outputs.scraper == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: scraper/.venv
          key: venv-scraper-audit-${{ hashFiles('scraper/poetry.lock') }}
      - run: cd scraper && poetry install --only main --no-interaction
      - run: cd scraper && .venv/bin/pip install pip-audit && .venv/bin/pip-audit

  audit-bot:
    needs: [changes]
    if: needs.changes.outputs.bot == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install poetry==${{ env.POETRY_VERSION }}
      - uses: actions/cache@v5
        with:
          path: bot/.venv
          key: venv-bot-audit-${{ hashFiles('bot/poetry.lock') }}
      - run: cd bot && poetry install --only main --no-interaction
      - run: cd bot && .venv/bin/pip install pip-audit && .venv/bin/pip-audit

  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    needs: [lint-backend, lint-scraper, lint-core, lint-bot, lint-dockerfiles]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          for result in \
            "${{ needs.lint-backend.result }}" \
            "${{ needs.lint-scraper.result }}" \
            "${{ needs.lint-core.result }}" \
            "${{ needs.lint-bot.result }}" \
            "${{ needs.lint-dockerfiles.result }}"; do
            if [ "$result" != "success" ] && [ "$result" != "skipped" ]; then
              exit 1
            fi
          done

  test:
    needs: [test-backend, test-scraper, test-bot]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          for result in \
            "${{ needs.test-backend.result }}" \
            "${{ needs.test-scraper.result }}" \
            "${{ needs.test-bot.result }}"; do
            if [ "$result" != "success" ] && [ "$result" != "skipped" ]; then
              exit 1
            fi
          done

  security:
    needs: [audit-backend, audit-scraper, audit-bot, gitleaks]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          for result in \
            "${{ needs.audit-backend.result }}" \
            "${{ needs.audit-scraper.result }}" \
            "${{ needs.audit-bot.result }}" \
            "${{ needs.gitleaks.result }}"; do
            if [ "$result" != "success" ] && [ "$result" != "skipped" ]; then
              exit 1
            fi
          done
